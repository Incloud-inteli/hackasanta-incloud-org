import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Edit2, Save, X } from 'lucide-react';
import pacienteService from '../../../services/pacienteService';
import { supabase } from '../../../services/supabaseClient';
import './Prontuario.css';

// ==========================
// FUN칂츾O: GERA RESUMO E ALERTAS
// ==========================
const gerarResumoEAlertas = (paciente) => {
    const alertas = [];
    const resumos = [];
    const dadosPessoais = paciente.dadosPessoais || {};
    const historicoMedico = paciente.historicoMedico || {};
    const historicoFamiliar = paciente.historicoFamiliar || {};

    // === INFORMA칂칏ES B츼SICAS ===
    resumos.push(`Paciente: ${dadosPessoais.nomeCompleto || 'Nome n칚o informado'}`);

    if (dadosPessoais.dataNascimento) {
        const idade = calcularIdade(dadosPessoais.dataNascimento);
        resumos.push(`Idade: ${idade} anos`);
    }

    // === ALERTAS CL칈NICOS ===
    if (dadosPessoais.tipoSanguineo) {
        alertas.push(`丘멆잺 TIPO SANGU칈NEO: ${dadosPessoais.tipoSanguineo.toUpperCase()}`);
    }

    if (historicoMedico.alergias && historicoMedico.alergias !== 'nenhum') {
        alertas.push(`游뚿 ALERGIAS: ${historicoMedico.alergias}${historicoMedico.alergiasOutro ? ` - ${historicoMedico.alergiasOutro}` : ''}`);
    }

    if (historicoMedico.doencasCronicas && historicoMedico.doencasCronicas !== 'nenhum') {
        alertas.push(`丘멆잺 DOEN칂AS CR칎NICAS: ${historicoMedico.doencasCronicas}${historicoMedico.doencasCronicasOutro ? ` - ${historicoMedico.doencasCronicasOutro}` : ''}`);
    }

    if (historicoMedico.medicamentos && historicoMedico.medicamentos !== 'nenhum') {
        alertas.push(`丘멆잺 MEDICAMENTOS EM USO: ${historicoMedico.medicamentos}${historicoMedico.medicamentosOutro ? ` - ${historicoMedico.medicamentosOutro}` : ''}`);
    }

    // === HIST칍RICO FAMILIAR DE C츽NCER (ALERTA DE DIAGN칍STICO PRECOCE) ===
    if (historicoFamiliar.possuiCancer === 'sim') {
        alertas.push(`丘멆잺 HIST칍RICO FAMILIAR DE C츽NCER: ${historicoFamiliar.tipoCancer || 'Tipo n칚o especificado'}${historicoFamiliar.tipoCancerOutro ? ` - ${historicoFamiliar.tipoCancerOutro}` : ''}`);
        resumos.push('游댌 Recomenda칞칚o: acompanhamento m칠dico regular e exames preventivos conforme faixa et치ria.');
    }

    // === CONDI칂칏ES RELACIONADAS AO RISCO ONCOL칍GICO ===
    if (historicoMedico.doencasCronicas?.toLowerCase().includes('hormonal') ||
        historicoMedico.doencasCronicas?.toLowerCase().includes('hep치tica') ||
        historicoMedico.doencasCronicas?.toLowerCase().includes('intestinal')) {
        alertas.push('丘멆잺 Condi칞칫es que podem aumentar risco oncol칩gico. Avalia칞칚o preventiva recomendada.');
    }

    if (historicoMedico.tratamentos?.toLowerCase().includes('radioterapia') ||
        historicoMedico.tratamentos?.toLowerCase().includes('quimioterapia')) {
        resumos.push('游늶 Paciente com hist칩rico de tratamento oncol칩gico. Manter acompanhamento peri칩dico.');
    }

    // === INFORMA칂칏ES ADICIONAIS ===
    if (historicoMedico.cirurgias === 'sim') resumos.push('Possui hist칩rico de cirurgias.');
    if (historicoMedico.internacoes === 'sim') resumos.push('Possui hist칩rico de interna칞칫es.');
    if (historicoMedico.problemasNascimento && historicoMedico.problemasNascimento !== 'nenhum') {
        resumos.push(`Problemas no nascimento: ${historicoMedico.problemasNascimento}`);
    }
    if (historicoMedico.historicoSaude) resumos.push(`Hist칩rico de sa칰de: ${historicoMedico.historicoSaude}`);

    // === ALERTA FINAL: MONITORAMENTO ===
    if (historicoFamiliar.possuiCancer === 'sim' || historicoMedico.doencasCronicas) {
        alertas.push('游빐 ALERTA: Dados indicam poss칤vel necessidade de diagn칩stico precoce e acompanhamento preventivo.');
    }

    return `=== ALERTAS IMPORTANTES ===\n${alertas.join('\n')}\n\n=== RESUMO GERAL ===\n${resumos.join('\n')}`;
};

// ==========================
// FUN칂츾O: CALCULAR IDADE
// ==========================
const calcularIdade = (dataNascimento) => {
    const hoje = new Date();
    const nascimento = new Date(dataNascimento);
    let idade = hoje.getFullYear() - nascimento.getFullYear();
    const mesAtual = hoje.getMonth();
    const mesNascimento = nascimento.getMonth();

    if (mesAtual < mesNascimento || (mesAtual === mesNascimento && hoje.getDate() < nascimento.getDate())) {
        idade--;
    }

    return idade;
};

// ==========================
// COMPONENTE PRINCIPAL
// ==========================
const Prontuario = () => {
    const navigate = useNavigate();
    const [loading, setLoading] = useState(true);
    const [isEditing, setIsEditing] = useState(false);
    const [paciente, setPaciente] = useState(null);
    const [backupPaciente, setBackupPaciente] = useState(null);

    useEffect(() => {
        const carregarProntuario = async () => {
            try {
                setLoading(true);
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    navigate('/login');
                    return;
                }

                const pacientes = await pacienteService.getByUserId(user.id);
                if (!pacientes || pacientes.length === 0) {
                    alert('Nenhuma ficha encontrada. Complete seu cadastro.');
                    navigate('/ficha-cadastro');
                    return;
                }

                const p = pacientes[0];
                const { data: prontuario } = await supabase
                    .from('Prontuarios')
                    .select('*')
                    .eq('ID_Paciente', p.id)
                    .single();

                const pacienteCarregado = {
                    ...p,
                    dadosPessoais: p.dadosPessoais || p.dados_pessoais || {},
                    historicoMedico: p.historicoMedico || p.historico_medico || {},
                    historicoFamiliar: p.historicoFamiliar || p.historico_familiar || {},
                    prontuario: prontuario || null,
                };

                // 游댠 Gera resumo e alertas com foco em diagn칩stico precoce
                const resumoGerado = gerarResumoEAlertas(pacienteCarregado);
                const resumoSalvo = prontuario?.ResumoGeralSaude || prontuario?.resumo_geral_saude;

                pacienteCarregado.prontuario = {
                    ...pacienteCarregado.prontuario,
                    ResumoGeralSaude: resumoSalvo || resumoGerado,
                };

                setPaciente(pacienteCarregado);
            } catch (error) {
                console.error('Erro ao carregar prontu치rio:', error);
                alert('Erro ao carregar prontu치rio.');
            } finally {
                setLoading(false);
            }
        };

        carregarProntuario();
    }, [navigate]);

    // ==========================
    // HANDLERS
    // ==========================
    const handleEditClick = () => {
        setBackupPaciente(JSON.parse(JSON.stringify(paciente)));
        setIsEditing(true);
    };

    const handleCancel = () => {
        setPaciente(backupPaciente);
        setIsEditing(false);
    };

    const handleFieldChange = (section, field, value) => {
        setPaciente(prev => ({
            ...prev,
            [section]: {
                ...prev[section],
                [field]: value,
            }
        }));
    };

    const handleSave = async () => {
        try {
            const updateData = {
                usuario_id: paciente.usuario_id,
                dadosPessoais: paciente.dadosPessoais,
                historicoMedico: paciente.historicoMedico,
                historicoFamiliar: paciente.historicoFamiliar,
            };
            await pacienteService.update(paciente.id, updateData);
            setIsEditing(false);
            alert('Dados atualizados com sucesso!');
        } catch (error) {
            console.error('Erro ao salvar:', error);
            alert('Erro ao salvar dados. Tente novamente.');
        }
    };

    // ==========================
    // RENDERIZA칂츾O
    // ==========================
    if (loading) return <main className="prontuario-page"><p>Carregando prontu치rio...</p></main>;
    if (!paciente) return <main className="prontuario-page"><p>Nenhum paciente encontrado.</p></main>;

    return (
        <main className="prontuario-page">
            <h1 className="prontuario-title">Prontu치rio</h1>

            {/* === RESUMO E ALERTAS === */}
            <div className="prontuario-card alerts-card">
                <h2 className="card-title">Resumo e Alertas</h2>
                <div className="card-content">
                    {paciente.prontuario?.ResumoGeralSaude ? (
                        <div className="prontuario-resumo">
                            {paciente.prontuario.ResumoGeralSaude.split('\n').map((linha, index) => {
                                const className = linha.includes('游뚿')
                                    ? 'alerta-critico'
                                    : linha.includes('丘멆잺')
                                    ? 'alerta-importante'
                                    : linha.includes('游댌')
                                    ? 'alerta-prevencao'
                                    : linha.includes('===')
                                    ? 'secao-titulo'
                                    : 'texto-normal';
                                return (
                                    <div key={index} className={className}>
                                        {linha}
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <p>Nenhum resumo ou alerta dispon칤vel.</p>
                    )}
                </div>
            </div>

            {/* DADOS PESSOAIS */}
            <div className="prontuario-card">
                <h2 className="card-title">Dados Pessoais</h2>
                <div className="card-content">
                    <div className="data-row"><span className="data-label">Nome:</span> {paciente.dadosPessoais?.nomeCompleto || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Data de nascimento:</span> {paciente.dadosPessoais?.dataNascimento ? new Date(paciente.dadosPessoais.dataNascimento).toLocaleDateString('pt-BR') : 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">CPF:</span> {paciente.dadosPessoais?.cpf || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Telefone:</span> {paciente.dadosPessoais?.telefone || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Email:</span> {paciente.dadosPessoais?.email || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">G칡nero:</span> {paciente.dadosPessoais?.genero || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Endere칞o:</span> {paciente.dadosPessoais?.endereco || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Estado Civil:</span> {paciente.dadosPessoais?.estadoCivil || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Ra칞a:</span> {paciente.dadosPessoais?.raca || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Profiss칚o:</span> {paciente.dadosPessoais?.profissao || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Tipo Sangu칤neo:</span> {paciente.dadosPessoais?.tipoSanguineo || 'N칚o informado'}</div>
                </div>
            </div>

            {/* HIST칍RICO M칄DICO */}
            <div className="prontuario-card">
                <h2 className="card-title">Hist칩rico M칠dico</h2>
                <div className="card-content">
                    <div className="data-row"><span className="data-label">Hist칩rico de Sa칰de:</span> {paciente.historicoMedico?.historicoSaude || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Cirurgias:</span> {paciente.historicoMedico?.cirurgias || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Alergias:</span> {paciente.historicoMedico?.alergias || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Interna칞칫es:</span> {paciente.historicoMedico?.internacoes || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Doen칞as Cr칪nicas:</span> {paciente.historicoMedico?.doencasCronicas || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Problemas no Nascimento:</span> {paciente.historicoMedico?.problemasNascimento || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Medicamentos:</span> {paciente.historicoMedico?.medicamentos || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Tratamentos:</span> {paciente.historicoMedico?.tratamentos || 'N칚o informado'}</div>
                </div>
            </div>

            {/* HIST칍RICO FAMILIAR */}
            <div className="prontuario-card">
                <h2 className="card-title">Hist칩rico Familiar</h2>
                <div className="card-content">
                    <div className="data-row"><span className="data-label">Possui C칙ncer na Fam칤lia:</span> {paciente.historicoFamiliar?.possuiCancer || 'N칚o informado'}</div>
                    <div className="data-row"><span className="data-label">Tipo de C칙ncer:</span> {paciente.historicoFamiliar?.tipoCancer || 'N칚o informado'}</div>
                </div>
            </div>
        </main>
    );
};

export default Prontuario;
